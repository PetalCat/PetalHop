services:
  petalhop:
    image: ghcr.io/petalcat/petalhop:latest
    build: .
    container_name: petalhop-server
    restart: unless-stopped
    ports:
      - "3000:3000" # Web UI
      - "51820:51820/udp" # WireGuard VPN
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    volumes:
      - ./data:/app/data # Persist SQLite Database
      - ./wireguard:/etc/wireguard # Persist WireGuard Config
    environment:
      - DATABASE_URL=file:/app/data/local.db
      - ORIGIN=https://testhop.petalcat.dev # Updated to your domain
      - SERVER_ENDPOINT=host.docker.internal:51820 # Connect to host's WG port
      - BODY_SIZE_LIMIT=512M
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1

  agent:
    build: ./src/agent
    container_name: petalhop-agent
    restart: unless-stopped
    depends_on:
      - petalhop
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TOKEN=${AGENT_TOKEN:-changeme}
      - CONTROLLER_URL=http://petalhop-server:3000
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
